{% extends "pttrack/base.html" %}

{# unclear if this should be done in base.html or here... #}
{% load bootstrap3 %}

{% block title %}
Patient Details: {{ patient.last_name }}, {{ patient.first_name }} {{ patient.middle_name }}
{% endblock %}

{% block header %}
<div class="col-md-5">
	<div class="col-md-1">
		<h2><br><a href="{% url 'all-patients' %}">{% bootstrap_icon "chevron-left" %}</a></h2>
	</div>
	<div class="col-md-11">
		<h2>{{ patient.last_name }}, {{ patient.first_name }} {{ patient.middle_name }} <a href="{% url 'patient-update' pk=patient.id %}"><small>{% bootstrap_icon "pencil" %}</small></a></h2>
		<p class="lead">{{ patient.age }} y/o {{ patient.ethnicities.iterator | join:", " }} {{ patient.gender | lower }}</p>
		<p class="lead"><strong>Status:</strong> {{ patient.status }}</p>
		{% if request.session.clintype_pk == "Coordinator" %}
			{% if patient.needs_workup %}
  	    <p class="lead"> Patient is Active <a href="{% url 'patient-activate-detail' pk=patient.id %}">{% bootstrap_icon "remove-circle" %}</a></p>
      {% endif %}
      {% if not patient.needs_workup %}
    	  <p class="lead"> Patient is Inactive <a href="{% url 'patient-activate-detail' pk=patient.id %}">{% bootstrap_icon "play-circle" %}</a></p>
      {% endif %}
    {% else %}
      {% if patient.needs_workup %}
	      <p class="lead"> Patient is Active </p>
      {% endif %}
      {% if not patient.needs_workup %}
  	    <p class="lead"> Patient is Inactive </p>
      {% endif %}
    {% endif %}
	</div>
</div>
<div class="col-md-4 text-center pull-right" style="border: 2px  black">
	<h3> Actions </h3>
	<div class="btn-group-verticle">
    <a class="btn btn-success pull-left btn-block" href="{% url 'new-workup' pt_id=patient.pk %}" role="button">Create New Workup</a>
    <a class="btn btn-info pull-left btn-block" href="{% url 'new-action-item' pt_id=patient.pk %}" role="button">Create New Action Item</a>
    <a class="btn btn-warning pull-left btn-block" href="{% url 'new-document' pt_id=patient.pk %}" role="button">Upload Document or Prescription</a>
    <a class="btn btn-primary pull-left btn-block" href="{% url 'followup-choice' pt_id=patient.pk %}" role="button">Create New Followup</a>
	</div>
</div>
{% endblock %}

{% block content %}

{% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}

<div class="container">
	<h3>&nbsp;&nbsp;Demographic Information</h3>
	<div class="container col-md-4">
		<p><strong>&nbsp;&nbsp;Language:</strong> {{ patient.languages.iterator | join:", " }}</p>
		<p><strong>&nbsp;&nbsp;DOB:</strong> {{patient.date_of_birth}}</p>
		<p><strong>&nbsp;&nbsp;SSN:</strong> {{patient.ssn | default:"Not Provided"}}</p>
	</div>
	<div class="container col-md-4">
		<p>
		<strong>Address:</strong><br>
		{{ patient.address }}<br>
		{{ patient.city }}, {{ patient.state }} {{ patient.zip_code }}
		</p>
	</div>
	<div class="container col-md-4">
		<table class="table table-condensed">
			<tr><th>Contact</th><th>Phone Number</th></tr>
		{% for phone, owner in patient.all_phones %}
			{% if phone or owner %}
			<tr><td>{{ owner | default:"Primary" }}</td><td>{{ phone }}</td></tr>
			{% endif %}
		{% endfor %}
		</table>
	</div>
</div>

<div class="container">
	<div class="col-md-6">
		<h3>Submitted Notes ({{ patient.notes | length }} Total)</h3>
		<div class="panel-group">
  			<div class="panel panel-default">
  				{% with patient.workup_set.all as note_set %}
	    			<div class="panel-heading">
	      				<h4 class="panel-title">
	        			<a data-toggle="collapse" href="#collapse1">Workups ({{ note_set | length }})</a>
	      				</h4>
	    			</div>
	    			<div id="collapse1" class="panel-collapse collapse">
	      				{% for note in note_set %}	
	  						<div class="panel-body">
								<p><a href="{% url 'workup' pk=note.pk %}"><strong>Workup:</strong></a> {{ note.short_text }}</p>
								<p class="text-muted text-right">by {{ note.author }} ({{ note.author_type }}) at {{ note.written_datetime }}</p>
								{% if request.session.clintype_pk == "Coordinator" %}
								<p class="text-right">
								<a href="{% url 'admin:pttrack_workup_change' note.id %}" target="_blank"><i>Edit</i></a></p>
								</p>
								{% endif %}
	  						</div>
	      				{% endfor %}	
	    			</div>
    			{% endwith %}
  			</div>
  			<div class="panel panel-default">
  				{% with patient.document_set.all as note_set %}
	    			<div class="panel-heading">
	      				<h4 class="panel-title">
	        			<a data-toggle="collapse" href="#collapse2">Uploaded Prescriptions and Documents ({{ note_set | length }})</a>
	      				</h4>
	    			</div>
	    			<div id="collapse2" class="panel-collapse collapse">
	      				{% for note in note_set %}	
	  						<div class="panel-body">
								<p><a href="{% url 'document-detail' pk=note.pk %}"><strong>{{ note.document_type | title }}:</strong></a> {{ note.short_text }}</p>
								<p class="text-muted text-right">by {{ note.author }} ({{ note.author_type }}) at {{ note.written_datetime }}</p>
								{% if request.session.clintype_pk == "Coordinator" %}
								<p class="text-right">
								<a href="{% url 'admin:pttrack_document_change' note.id %}" target="_blank"><i>Edit</i></a></p>
								</p>
								{% endif %}
	  						</div>
	      				{% endfor %}	
	    			</div>
    			{% endwith %}
  			</div>
  			<div class="panel panel-default">
  				{# followup_set is a custom method in the patient object returns a list rather than a queryset, so no .all() #}
  				{% with patient.followup_set as note_set %}
    			<div class="panel-heading">
      				<h4 class="panel-title">
        			<a data-toggle="collapse" href="#collapse3">Followups ({{ note_set | length }})</a>
      				</h4>
    			</div>
    			<div id="collapse3" class="panel-collapse collapse">
      				{% for note in note_set %}	
  							<div class="panel-body">
								{# here, the url takes an arugment to route it to the correct  #}
								<p><a href="{% url 'followup' pk=note.pk model=note.type %}"><strong>{{ note.type }} Followup:</strong></a> {{ note.short_text }}</p>
								<p class="text-muted text-right">by {{ note.author }} ({{ note.author_type }}) at {{ note.written_datetime }}</p>
								{% if request.session.clintype_pk == "Coordinator" %}
								<p class="text-right">
									{% if note.CS_HELP %}
									<a href="{% url 'admin:pttrack_labfollowup_change' note.id %}" target="_blank"><i>Edit</i></a></p>
									{% elif note.SUBSQ_DOSE_HELP %}
									<a href="{% url 'admin:pttrack_vaccinefollowup_change' note.id %}" target="_blank"><i>Edit</i></a></p>
									{% elif note.REFTYPE_HELP %}
									<a href="{% url 'admin:pttrack_referralfollowup_change' note.id %}" target="_blank"><i>Edit</i></a></p>
									{% else %}
									<a href="{% url 'admin:pttrack_generalfollowup_change' note.id %}" target="_blank"><i>Edit</i></a></p>
									{% endif %}
								{% endif %}
  							</div>
      				{% endfor %}	
    			</div>
    			{% endwith %}
  			</div>
		</div>
	</div>
	<div class="col-md-6">
		<h3>Active Action Items ({{ patient.active_action_items | length }})</h3>
		<table class="table">
			{% for action_item in patient.active_action_items %}
			<tr><td><a href="{% url 'done-action-item' ai_id=action_item.pk %}"/> {% bootstrap_icon "unchecked" %}</a></td>
				<td>
				<p><strong><a href="{% url 'update-action-item' pk=action_item.pk%}">{{ action_item.instruction }}:</a></strong> {{ action_item.comments }}</p>
				<p class="text-muted text-right">{{ action_item.author }} on {{ action_item.written_datetime }}</p>
				{% if request.session.clintype_pk == "Coordinator" %}
					<p class="text-right"><a href="{% url 'admin:pttrack_actionitem_change' action_item.id %}" target="_blank"><i>Edit</i></a></p>
				{% endif %}
			</td></tr>
			{% empty %}
				<p class="text-muted"> No due action items for {{ patient.name }}</p>
			{% endfor %}
		</table>

		<h3>Pending Action Items ({{ patient.inactive_action_items | length }})</h3>
		<table class="table">
			{% for action_item in patient.inactive_action_items %}
			<tr><td><a href="{% url 'done-action-item' ai_id=action_item.pk %}"/> {% bootstrap_icon "unchecked" %}</a></td>
				<td>
					<p><strong><a href="{% url 'update-action-item' pk=action_item.pk %}">{{ action_item.instruction }}:</a></strong>, due {{action_item.due_date}}: {{ action_item.comments }}</p>
					<p class="text-muted  text-right"> Written by {{ action_item.author }} on {{ action_item.written_datetime }}</p>
					{% if request.session.clintype_pk == "Coordinator" %}
						<p class="text-right"><a href="{% url 'admin:pttrack_actionitem_change' action_item.id %}" target="_blank"><i>Edit</i></a></p>
					{% endif %}
				</td></tr>
			{% empty %}
				<p class="text-muted"> No pending action items for {{ patient.name }}</p>
			{% endfor %}
		</table>

		<h3>Completed Action Items ({{ patient.done_action_items | length }})</h3>
		<table class="table">
			{% for action_item in patient.done_action_items %}
			<tr><td><a href="{% url 'reset-action-item' ai_id=action_item.pk %}"/> {% bootstrap_icon "check" %}</a></td>
				<td>
					<p><strong><a href="{% url 'update-action-item' pk=action_item.pk%}">{{ action_item.instruction }}:</a></strong> {{ action_item.comments }}</p>
					<p class="text-muted  text-right">Marked done by {{ action_item.completion_author }} on {{ action_item.completion_date }}</p>
					{% if request.session.clintype_pk == "Coordinator" %}
						<p class="text-right"><a href="{% url 'admin:pttrack_actionitem_change' action_item.id %}" target="_blank"><i>Edit</i></a></p>
					{% endif %}
				</td></tr>
			{% empty %}
				<p class="text-muted"> No finished action items for {{ patient.name }}</p>
			{% endfor %}
		</table>
	</div>
</div>
{% endblock %}
