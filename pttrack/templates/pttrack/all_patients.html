{% extends "pttrack/base.html" %}

{% load bootstrap3 %}

{% block title %}
Osler: {{ title | default:"All Patients"}}
{% endblock %}

{% block header %}
<h1>{{ title | default:"All Patients" }}</h1>
{% endblock %}

{% block extra_head %}
    {# font-awesome stylesheets #}
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
    }
{% endblock %}

{% block content %}
   <div class="container">
        <div class="form-group">
            <label for="all-patients-filter-input"  class="sr-only" >Filter</label>
            <div class="input-group">
                <div class="input-group-addon"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></div>
                <input type="text" id="all-patients-filter-input" placeholder="Filter by patient or case manager name" class="form-control" onkeyup="filterAllPatientsTable()">
            </div>
        </div>

        <table class="table" id="all-patients-table">
            <tr><th>Patient Name</th><th>Age/Gender</th><th>Case Managers</th><th>Latest Activity</th><th>Next AI Due</th><th>Attestation</th></td>
            {% for patient in object_list %}
                <tr>
                <td><a href="{% url 'patient-detail' pk=patient.pk %}">{{ patient.name }}</a></td>
                <td>{{ patient.age }}/{{patient.gender}}</td>
                <td>{{ patient.case_managers.iterator | join:"; " }}</td>
                {% if patient.latest_workup %}
                <td><a href="{% url 'workup' pk=patient.latest_workup.pk %}">Seen {{ patient.latest_workup.clinic_day.clinic_date }}</a>: {{patient.latest_workup.chief_complaint}}</td>
                {% else %}
                <td><a href="{% url 'patient-update' pk=patient.id %}">Intake</a>: {{patient.history.last.history_date}}</td>
                {% endif %}
                <td>{{patient.status}}</td>
                {% if not patient.latest_workup %}
                <td>No Note</td>
                {% elif not patient.latest_workup.signer %}
                <td>Unattested</td>
                {% else %}
                <td>{{ patient.latest_workup.signer }}</td>
                {% endif %}
                </tr>
            {% endfor %}
        </table>
	</div>
{% endblock %}

{% block extra_js %}
<script>
{# adapted from "https://www.w3schools.com/howto/howto_js_filter_table.asp" #}
function filterAllPatientsTable() {
  // Declare variables 
  var input, filter, table, tr, td, i;
  input = document.getElementById("all-patients-filter-input");
  filter = input.value.toUpperCase();
  table = document.getElementById("all-patients-table");
  tr = table.getElementsByTagName("tr");

  console.log(tr.length)

  // Loop through all table rows, and hide those who don't match the search query
  // Start at one to avoid hitting table header
  for (i = 1; i < tr.length; i++) {
    var match = 0;
    td = tr[i].getElementsByTagName("td")[0];
    if (td) {
        // need additional indexing because patient's name is a link
        if (check(td.getElementsByTagName("a")[0], filter)) {
            match = 1;
        }
    }
    td = tr[i].getElementsByTagName("td")[2];
    if (td) {
        if (check(td, filter)) {
            match = 1;
        } 
    }
    if (match == 1) {
      console.log("Showing", tr[i].getElementsByTagName("td")[0].getElementsByTagName("a")[0].innerHTML)
      tr[i].style.display = "";
    } else {
      console.log("Hiding", tr[i].getElementsByTagName("td")[0].getElementsByTagName("a")[0].innerHTML)
      tr[i].style.display = "none";
    }
  }
}

function check(haystack_element, needle){
    var haystack = haystack_element.innerHTML.toUpperCase()
    console.log('checking if', needle, 'in', haystack)
    if (!needle) {return 1}
    if (haystack && haystack.indexOf(needle) > -1) {
        console.log("present")
        return 1
    } else {
        console.log("not present")
        return 0
    }
}

</script>
{% endblock %}