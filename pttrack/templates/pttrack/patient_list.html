{% extends "pttrack/base.html" %}

{% load bootstrap3 %}

{% block title %}
Osler: {{ title | default:"All Patients"}}
{% endblock %}

{% block header %}
<h1>{{ title | default:"All Patients" }}</h1>
{% endblock %}

{% block content %}

<!-- <div class="container">
    <p> Filter by: <strong>[ item type ]</strong> due in the next <strong>[ n days ]</strong> <button type="submit" class="btn btn-success">Filter</button></p>
    <p> Sort by: <strong>[ field ]</strong> in <strong>[ ascending/descending ]</strong> order <button type="submit" class="btn btn-success">Sort</button></p>
</div> -->

<div class="container">
    <ul class="nav nav-pills">
        {% for combination in zipped_list %}
        {% if combination.3 %}
        <li class="active"><a data-toggle="pill" href="#{{ combination.2 }}">{{ combination.0 }}<span class="badge">{{ combination.1 | length }}</span></a></li>
        {% else %}
        <li><a data-toggle="pill" href="#{{ combination.2 }}">{{ combination.0 }}<span class="badge">{{ combination.1 | length }}</span></a></li>
        {% endif %}
        {% endfor %}
    </ul>
    <div class="tab-content">


        <!-- <div id="{{ combination.2 }}" class="tab-pane fade in active"></div> -->

        <div id="{{ combination.2 }}" class="tab-pane fade in active">
            <h3>Alphabetized by Last Name</h3>
            <table class="table" id = "by_last_name">
                <tr><th>Name</th><th>Age / Gender</th><th>Latest Activity</th><th>Next AI Due</th><th>Status</th></td>

                </table>
            </div>
        </div>




    </div>

    <script type="text/javascript">

    // function buildPatientTable(patients){
    //     for (var i = 0; i < patients.length; i++){

    //     }
    // }

    function doUponLoading(event){
        if ("{{title}}" == "All Patients"){ // else, need to set up API for attending tasks
        $.ajax({
            url: '/pttrack/patients.json',
            type: 'get',
            success: function(data) {
                console.log(data.length);
                // data.sort(function(a,b) {
                //     return a.born - b.born;
                // });
                // console.log(data);

                data.sort(function(a,b) {
                    var x = a.last_name.toLowerCase();
                    var y = b.last_name.toLowerCase();
                    return x < y ? -1 : x > y ? 1 : 0;
                });
                console.log(data);

                for (var i = 0; i < data.length; i++){
                    patient = data[i];
                    var patientRow = $("<tr>").append(
                        $("<td>").append(
                            $("<a>").attr({
                                href :"/pttrack/"+patient.pk
                            }).text(patient.name)),
                        $("<td>").text(patient.age+" / "+patient.gender)
                        );
                    if (patient.latest_workup){
                        $(patientRow).append(
                            $("<td>").append(
                                $("<a>").attr({
                                    href :"/workup/"+patient.latest_workup.pk
                                }).text("Seen "+patient.latest_workup.clinic_day.clinic_date),
                                $("<span>").text(": "+patient.latest_workup.chief_complaint))
                            );
                    } else{
                        $(patientRow).append(
                            $("<td>").append(
                                $("<a>").attr({
                                    href :"/pttrack/patient/update/"+patient.pk
                                }).text("Intake"),
                                $("<span>").text(": "+"patient.history.last.history_date"))
                            );
                    }
                    $(patientRow).append(
                        $("<td>").text(patient.status),
                        $("<td>").append(
                            $("<span>").text(function(){
                                return patient.needs_workup ? "Active " : "Inactive ";
                            }),
                            $("<a>").attr({
                                href :"/pttrack/patient/activate_home/"+patient.pk
                            }).append(
                            $("<span>").attr({
                                class :function(){
                                    return patient.needs_workup ? "glyphicon glyphicon-remove-circle" : "glyphicon glyphicon-play-circle";
                                },
                                'aria-hidden' : "true"
                            })
                            )
                            )                        
                        );
                    $('#by_last_name').append($(patientRow));
                }
                






            },
            failure: function(data) { 
                console.log('Error in ajax call');
            }
        }); 
}
    }
    document.addEventListener("DOMContentLoaded", doUponLoading, false);
</script>

{% endblock %}
